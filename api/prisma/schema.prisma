// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////////////////////////////////////////
//                              User Account                             // 
///////////////////////////////////////////////////////////////////////////
model User {
  id                       String                     @id @default(uuid())
  name                     String?

  language                 String                     @default("en")

  email                    String                     @unique
  passwordHash             String
  isEmailVerified          Boolean                    @default(false)

  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt

  // Relations
  accounts                 Account[]
  refreshTokens            RefreshToken[]

  projectGroups            ProjectGroup[]
  projects                 Project[]
}


model RefreshToken {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  tokenHash  String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revoked    Boolean  @default(false)
  replacedBy Int?

  @@index([userId])
}

model Account {
  id         String   @id @default(uuid())
  provider   String
  providerId String
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  /// Prevent duplicate provider+providerId entries
  @@unique([provider, providerId])
  @@index([userId])
}







////////////////////////////////////////////////////////////////////////////
//                      CVX ProjectGroups and Project                     //
////////////////////////////////////////////////////////////////////////////

// Step 1: Source of creation
enum InitialSource {
  SCRATCH       // Start from Scratch
  OLD_PROJECT   // Start from Old Project (CVX)
  OLD_DOCUMENT  // Start from Old Document (CVX PDF/DOCX)
  EXTERNAL_CV   // Start from External CV (PDF/DOCX)
  LINKEDIN      // Start from LinkedIn
  CALL_AGENT   // Created by a CVX staff member during a call/session
}

// Template Catalog (independent model)
model Template {
  id        String   @id @default(uuid())
  slug      String   @unique
  name      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  Project[]
}

// Multi-language group created from wizard:
// Example: "CV 1", "CV Ahmed Work"
model ProjectGroup {
  id            String        @id @default(uuid())

  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String

  // Sequential index per user: 1, 2, 3...
  cvIndex       Int

  // Wizard Step 1
  initialSource InitialSource
  initialMeta   Json?

  // All language projects inside this group
  projects      Project[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([userId, cvIndex])
  @@index([userId, createdAt])
}

// Single CV (one language version)
model Project {
  id         String        @id @default(uuid())

  groupId    String
  group      ProjectGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  userId     String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  language   String   // "en", "fr", "ar", ...

  name       String   // "CV 1 â€“ English", "CV Ahmed Work English"

  templateId String?
  template   Template?     @relation(fields: [templateId], references: [id])

  data       Json

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([groupId, language])
  @@index([userId, createdAt])
}